@{
    ViewBag.Title = "Home Page";
}


<div class="row">
    <div class="jumbotron">
        <div class="row">
            <div class="col-lg-12"><h1>MN United Season Tickets</h1></div>
        </div>

    </div>

</div>

<div class="row">
    <ul class="nav nav-tabs">
        <li><a data-toggle="tab" yearId="0" href="#2019">2019</a></li>
        <li class="active"><a data-toggle="tab" yearId="1" href="#2020">2020</a></li>
    </ul>

    <div class="tab-content">
        <div id="2019" class="tab-pane fade">
            

        </div>
        <div id="2020" class="tab-pane fade in active">




        </div>
    </div>
</div>



@*<div class="row" style="border: 1px solid #e1e1e8; border-radius: 4px;">
    <div class="col-lg-6">
        <form style="margin-top: 10px">
            <div class="form-group"><label>Unused Tickets</label><input class="form-control" id="ticketsAvailable" disabled="disabled" /></div>
            <div class="form-group"><label>Unused Ticket Total</label><input class="form-control" id="ticketsValue" disabled="disabled" /></div>
            <div class="form-group"><label>Season Ticket Price</label><input class="form-control" id="singleTicketValue" value="23.06" disabled="disabled" /></div>
            <div class="form-group"><label>Device</label><input class="form-control" id="device" disabled="disabled" /></div>
        </form>
    </div>
    <div class="col-lg-6">
        <table class="table" id="ticketTable">
            <caption>Ticket breakdown</caption>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Tickets</th>
                    <th>Value</th>
                    <th>Paid</th>
                </tr>
            </thead>
            <tbody>

            </tbody>
        </table>
    </div>
</div>*@
@*<div class="row" id="mobileLegend" style="margin-top: 30px">
    <div class="col-lg-2">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    Legend
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">Click event to change ticket holders.</h6>
                <p class="card-text">
                    <table style="border-collapse: separate; border-spacing: 2px;">
                        <tr>
                            <td><div style="background-color: #337ab7; width: 20px; height: 20px"></div></td>
                            <td><div> = All tickets open</div></td>
                        </tr>
                        <tr>
                            <td><div style="background-color: green; width: 20px; height: 20px"></div></td>
                            <td><div> = All tickets used</div></td>
                        </tr>
                        <tr>
                            <td><div style="background-color: orange; width: 20px; height: 20px"></div></td>
                            <td><div> = One ticket used</div></td>
                        </tr>
                    </table>

                </p>
            </div>
        </div>
    </div>
</div>*@
<div class="row" style="margin-top: 30px">
    <div class="col-lg-10">
        <div id='calendarApril'></div>
    </div>
    <div class="col-lg-2">
        <div class="card"  id="eventLegend">
            <div class="card-body">
                <h5 class="card-title">
                    Legend
                </h5>
                <h6 class="card-subtitle mb-2 text-muted">Click event to change ticket holders.</h6>
                <p class="card-text">
                    <table style="border-collapse: separate; border-spacing: 2px;">
                        <tr>
                            <td><div style="background-color: #337ab7; width: 20px; height: 20px"></div></td>
                            <td><div> = All tickets open</div></td>
                        </tr>
                        <tr>
                            <td><div style="background-color: green; width: 20px; height: 20px"></div></td>
                            <td><div> = All tickets used</div></td>
                        </tr>
                        <tr>
                            <td><div style="background-color: orange; width: 20px; height: 20px"></div></td>
                            <td><div> = One ticket used</div></td>
                        </tr>
                    </table>



                </p>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    //$('#mobileLegend').hide();

    //$(window).scroll(function () {
    //    $("#eventLegend").stop().animate({ "marginTop": ($(window).scrollTop()) + "px", "marginLeft": ($(window).scrollLeft()) + "px" }, "slow");
    //});
    

    $(document).ready(function () {

        //if (/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        //    $("#eventLegend").remove();
        //    $('#mobileLegend').show();
        //}

        var firstDay = new Date();


        function getStats() {
            $.getJSON('/Home/GetEventStats').done(function (data) {

                $('#ticketsAvailable').val(data.ticketsOpen);
                $('#ticketsValue').val(data.ticketOpenValue.toFixed(2));
                $("#ticketTable tbody tr").remove(); 
                data.ticketUserList.forEach(function (item) {

                    $('#ticketTable').append('<tr><td>' + item.Name + '</td><td>' + item.ticketCount + '</td><td>' + item.ticketValue.toFixed(2) + '</td><td>' + item.amountPaid +'</td></tr>');
                });

            });
        }

        getStats();

        function loadEvents(yearId) {

            $('#calendarApril').fullCalendar('destroy');

            $.getJSON('/Home/GetEvents', {yearId: yearId}).done(function (data) {

                $('#calendarApril').fullCalendar({
                    defaultDate: firstDay,
                    contentHeight: "auto",
                    events: data,
                    eventClick: function (event, element) {
                        console.log(event.id + ' clicked.');
                        bootbox.confirm("<form id='myform' action='/Home/SubmitChange' method='post'>" +
                            "<input type='hidden' name='id' value='" + event.id + "'>" +
                            "<div class='form-group'><label>Ticket 1</label>" +
                            "<input type='text' name='ticket1' class='form-control' value='" + event.ticket1 + "' /></div>" +
                            "<div class='form-group'><label>Ticket 2</label><input type='text' name='ticket2' class='form-control' value='" + event.ticket2 + "' /></div></form>"
                            , function (result) {
                                if (result) {
                                    $.ajax({
                                        url: '/Home/SubmitChange',
                                        type: 'POST',
                                        dataType: 'json',
                                        data: $("#myform").serialize(),
                                        success: function (data) {
                                            $('#calendarApril').fullCalendar('removeEvents', event.id);
                                            $('#calendarApril').fullCalendar('renderEvent', data);
                                            getStats();
                                        }
                                    });
                                }
                            });
                    },
                    eventRender: function (event, element) {
                        var image = $('<img/>').attr("src", event.img).attr("height", 36);
                        element.find('.fc-title').append("<br/>");
                        element.find('.fc-title').append(image);
                        element.find('.fc-title').append("<br/> Ticket 1: " + event.ticket1 + "<br/> Ticket 2: " + event.ticket2);

                    },
                    showNonCurrentDates: false
                });

            });
        }

        //loadEvents();

        function loadTicketBreakdown(id) {

            $.getJSON('/Home/GetYearModel', { yearId: id }).done(function (data) {

                var curDate = new Date();

                var seasonDate = new Date(data.yearName, curDate.getMonth(), 1)

                firstDay = new Date(seasonDate.getFullYear(), seasonDate.getMonth(), 1);

                if (firstDay < new Date(seasonDate.getFullYear(), 2, 1)) {

                    firstDay = new Date(seasonDate.getFullYear(), 2, 1);

                }

                loadEvents(id);
            });

        }

        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("yearId") // activated tab
            loadTicketBreakdown(target);
        });

        loadTicketBreakdown(1);

    });




</script>